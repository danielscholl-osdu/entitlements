osdu-gcp-containerize-bootstrap-entitlements:
  stage: containerize
  image: docker:19.03.15
  tags: ["osdu-small"]
  services:
    - docker:20.10.7-dind
  variables:
    IMAGE_NAME: osdu-gcp-bootstrap-entitlements
  script:
    # Gitlab Container Registry
    - export EXTRA_DOCKER_TAG=""; if [ "$CI_COMMIT_TAG" != "" ] ; then EXTRA_DOCKER_TAG="-t $CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_TAG" ; elif [ "$CI_COMMIT_REF_NAME" = "master" ] ; then EXTRA_DOCKER_TAG="-t $CI_REGISTRY_IMAGE/$IMAGE_NAME:latest" ; fi
    - docker build -t $CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA $EXTRA_DOCKER_TAG --file provider/entitlements-v2-jdbc/bootstrap/Dockerfile .
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE/$IMAGE_NAME
  rules:
    - if: "$OSDU_GCP == 'true'"
      when: on_success

